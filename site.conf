location /Login {
    add_header X-username "$remote_user";
    return 204;
}

location /Alloc {
    default_type 'text/plain';

    content_by_lua_block {
        local args, err = ngx.req.get_uri_args()
        base = args["base"]
        if not base then ngx.exit(400) end

        if not string.match(base, "^[A-Za-z0-9_-]+$") then ngx.exit(422) end

        full_prefix = ngx.var.document_root .. "/Saves/" .. base .. os.date("_%d-%m-%y_%H-%M_")

        suffix = 0
        while true do
            local file, err = io.open(full_prefix .. suffix .. ".json", "r")
            if file then
                suffix = suffix + 1
            else
                break
            end
        end
        local full_name = full_prefix .. suffix .. ".json"

        local file, err = io.open(full_name, "w")
        if not file then ngx.exit(500) end
        file:close()

        trunc_name = string.match(full_name, "([^/]+)$")
        ngx.say(trunc_name)
    }
}

location /Saves {
    autoindex on;
    dav_methods PUT;

    set $c_flag "$request_method";
    if (!-f $request_filename) {
        set $c_flag "${c_flag}+";
    }
    if ($c_flag = "PUT+") {
        return 409;
    }
}